{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    <div class="p-5 mb-4 bg-light rounded-3">
        <div class="container-fluid py-2">
            <h1 class="display-5 fw-bold text-center">{{owner.nickname}}의 마이페이지</h1>
            {% if user.id == owner.id %}
                <a href="{% url 'info_edit' user.pk %}">개인정보 수정</a>
            {% endif %}
            <div>
                {% if owner.nickname in names_to_exclude %}
                    {% if not owner.id == user.id %}
                        <a href="{% url 'deletefriend' owner.pk%}">UnFollow</a>
                    {% endif %}
                {% else %}
                    <a href="{% url 'addfriend' owner.pk%}">Follow</a>
                {% endif %}
            </div>
            </br>
            <div>
                {% if visit_cafes %}
                    <button class="btn btn-primary btn-sm" onClick="location.href='{% url 'user_cafe_map' %}'">나의 카페 지도 보러가기</button>
                {% endif %}
            </div>
            <p class="col-md-8 fs-4">
                <span>획득한 배지 개수: {{ total_badge_count }}개 </span>
                <button class="btn btn-primary btn-sm" onClick="location.href='{% url 'badge_list' owner.pk %}'">배지 리스트 보기</button>
                <br>
                <span>작성한 리뷰 수 : {{all_review_count}}개 </span>
                <button class="btn btn-primary btn-sm" onClick="location.href='{% url 'myreview_list' %}'">작성한 리뷰 보기</button>
                <br>
                <span>총 방문 카페 수 : {{visit_cafes.count }} 곳</span><br>
                <span>총 카페 방문 횟수 : {{ total_visit }} 회</span><br>
                <span>Following : {{ followingnum }} 명</span><br>
                <span>Follwer : {{ owner.follwernum }} 명</span><br>
            </p>
        </div>
    </div>

    <div class="row align-items-md-stretch">
        <div class="col-md-6">
            <div class="h-100 p-5 bg-dark rounded-3">
                <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample1" aria-expanded="false" aria-controls="collapseExample">
                    획득한 배지 보기
                </button>
                <div class="collapse" id="collapseExample1">
                    <div class="card card-body">
                        {% for badge in taken_badges %}
                            <p>
                                <img src="{{badge.badge_image.url}}" style="width: 5%; height: 5%;">
                                <span>{{badge.badge_name}}</span>
                            </p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="h-100 p-5 bg-light border rounded-3">
                <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample2" aria-expanded="false" aria-controls="collapseExample">
                    방문한 카페 보기
                </button>
                <div class="collapse" id="collapseExample2">
                    <div class="card card-body">
                        {% for cafe, drinks in drink_list_dic.items %} 
                            <span style="font-size: 20px; font-weight: bold">카페명 : <a href="{% url 'cafe:review_list' cafe.id%}">{{cafe}}</a></span>
                            <span> 방문 횟수: {{cafe.visit_count}}</span>
                            <span> 마신음료 : </span>
                            {% for drink in drinks %}
                                <span>{{drink}}</span>
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</br>
    <div class="row align-items-md-stretch">
        <div class="col-md-6">
            <div class="h-100 p-5  bg-light rounded-3">
                <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample3" aria-expanded="false" aria-controls="collapseExample">
                    작성한 리뷰 보기
                </button>

                <div class="collapse" id="collapseExample3">
                    <div class="card card-body">
                        <article class="each_review">
                            {% for reviews in my_all_review %}
                                <a href="{% url 'mypage' reviews.username.pk %}">{{ reviews.username }}</a> 

                                {% if reviews.review_stars == '1.0' %}
                                    <span>⭐</span>
                                {% elif reviews.review_stars == '2.0' %}
                                    <span>⭐⭐</span>
                                {% elif reviews.review_stars == '3.0' %}
                                    <span>⭐⭐⭐</span>
                                {% elif reviews.review_stars == '4.0' %}
                                    <span>⭐⭐⭐⭐</span>
                                {% elif reviews.review_stars == '5.0' %}
                                    <span>⭐⭐⭐⭐⭐</span>
                                {% endif %}
                                {{ reviews.created_at }}
                                <br/>
                                <span>{{ this_cafe.name }} 방문 횟수: {{reviews.visit_cafe.visit_count}} <!--세현 8/11삽질노트-->
                                </span>
                                <span>총 카페 방문 횟수: {{ reviews.username.total_visit }}</span>
                                <span>총 작성 리뷰 수: {{ reviews.username.total_review }}</span>
                                <br/>
                                {{ reviews.content }}<br/>

                                {% if review_photo %}
                                    {% for img in review_photo %}
                                        {% if img.review.id == reviews.id %}
                                            <img src="{{img.image.url}}" style="width: 5%; height: 5%;">         
                                        {% endif %}
                                    {% endfor %}   
                                {% endif %}
                                <br/>
                            

                                <div class="comments-{{reviews.id}}">
                                    <ul>
                                        {% for comment in comments %}
                                            {% if comment.post == reviews %}
                                                <li>
                                                    <div class="comment-{{comment.id}} container">
                                                        <div class="row">
                                                            <div class="col">{{comment.content}}</div>
                                                            <div class="col">{{comment.username}}</div>
                                                            <div class="col">{{comment.created_at}}</div>
                                                            <div class="col">
                                                                <button class="btn-primary" onclick="commentDelete('{{comment.id}}');">삭제</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </li>
                                            {% endif %}
                                        {% endfor %}
                                    </ul>
                                </div>
                                <input class="input-{{reviews.id}}" type="text" placeholder="댓글 달기"/>
                                <button class="btn btn-sm btn-primary" onclick="commentWrite('{{reviews.id}}');">게시</button>
                                <hr/>
                            {% endfor %}
                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="h-100 p-5 bg-dark border rounded-3">
                <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample4" aria-expanded="false" aria-controls="collapseExample">
                    팔로우 목록
                </button>
                {% if user.id == owner.id %}
                    <button class="btn btn-primary btn" onClick="location.href='{% url 'friend_search' %}'">유저 검색</button>
                {% endif %}
                <div class="collapse" id="collapseExample4">
                    <div>
                        <br>
                        {% for friend in friends %}
                            <div>
                                <li style="font-size: 20px; font-weight: bold"><a href="{% url 'mypage' friend.pk%}">{{ friend.nickname }}</a></li>
                                <br>
                            </div>
                        {% endfor %}
                    </div>
                </div>

            </div>
        </div>

        <div class="col-md-6">
            <div class="h-100 p-5 bg-dark text-white border rounded-3">
                <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample5" aria-expanded="false" aria-controls="collapseExample">
                    팔로워 목록
                </button>
                <div class="collapse" id="collapseExample5">
                    <div>
                        <br>
                        {% for follwer in follwers %}
                            <div>
                                <li style="font-size: 20px; font-weight: bold"><a href="{% url 'mypage' follwer.pk%}">{{ follwer.nickname }}</a></li>
                                
                                <br>
                            </div>
                        {% endfor %}
                    </div>
                </div>
        </div>
    </div>
</div>
<div id="map" style="width:500px; height:500px;"></div>

<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script>
// 방문한 카페 리스트
let cafeList = {{ visited_cafe_list | safe }};
// 가장 많이 방문한 카페의 pk값
let mainCafePk = {{ main_cafe | safe }};
// 모든 카페 리스트
let allPlaces = {{ cafe_list | safe }};
// 2차원 배열로 [0]에는 카페의 정보, [1]에는 카페 방문 횟수가 들어감
let userCafeList = [];
// 가장 많이 방문한 카페
let mainCafe;

// TODO: 최적화 작업 필요
// userCafeList에 원하는 정보들 삽입
// 지도 중심에 가장 많이 방문한 카페가 나오도록 설정
for(var i = 0; i < allPlaces.length; i++) {
    for(var j = 0; j < cafeList.length; j++) {
        if(allPlaces[i].pk === cafeList[j].fields.cafe) {
            userCafeList.push([allPlaces[i], cafeList[j].fields.visit_count]);
            if(cafeList[j].pk === mainCafePk) {
                mainCafe = allPlaces[i];
            }
        }
    }
}

var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
    mapOption = {
        center: new kakao.maps.LatLng(mainCafe.fields.location_y, mainCafe.fields.location_x), // 지도의 중심좌표
        level: 2 // 지도의 확대 레벨
    };

var map = new kakao.maps.Map(mapContainer, mapOption); // 지도 생성

var imageSrc = "https://image.flaticon.com/icons/png/512/3127/3127450.png", // 마커이미지의 주소    
    imageOption = {offset: new kakao.maps.Point(8, 16)};

// 현재 지도에 보이는 장소들의 정보를 저장하기 위한 배열
let places = [];
// marker 객체를 저장하기 위한 배열
let markers = [];
// 지도 영역정보
var bounds = map.getBounds();
// 영역정보의 남서쪽 정보
var swLatlng = bounds.getSouthWest();
// 영역정보의 북동쪽 정보
var neLatlng = bounds.getNorthEast();

markData(markers, userCafeList, swLatlng, neLatlng);

// 마커를 클릭하면 장소명을 표출할 인포윈도우
var infowindow = new kakao.maps.InfoWindow({zIndex:1, removable : true});
// 검색 목록을 hover하면 장소명을 표출할 인포윈도우
var infowindow_search = new kakao.maps.InfoWindow({zIndex:0}); 

// 지도가 움직일 때 발생하는 이벤트
// 지도가 움직일때마다 map의 정보들을 초기화
kakao.maps.event.addListener(map, 'bounds_changed', function() {             
    // 지도 영역정보
    bounds = map.getBounds();
    // 영역정보의 남서쪽 정보
    swLatlng = bounds.getSouthWest();
    // 영역정보의 북동쪽 정보
    neLatlng = bounds.getNorthEast();
    //지도 확대 제어
    if(neLatlng.Ma-swLatlng.Ma >= 0.0082) {
        map.setLevel(4);
    }

    // marker 초기화
    removeMarker();
    // places 초기화
    places = [];
    // 마커 데이터 추가
    markData(markers, userCafeList, swLatlng, neLatlng);
});

// 카페들을 지도에 마킹하는 함수
function markData(markers, userCafeList, sw, ne) {
    for(var i=0; i < userCafeList.length; i++) {
        if(userCafeList[i][0].fields.location_x < ne.La && userCafeList[i][0].fields.location_x > sw.La && userCafeList[i][0].fields.location_y < ne.Ma && userCafeList[i][0].fields.location_y > sw.Ma) {
            addMarker(markers, userCafeList[i], cafeList);
            places.push(userCafeList[i]);
        }
    }
}

// 마커를 생성하고 지도위에 표시하는 함수
function addMarker(markers, place, cafeList) {
    let iconSize;
    // 현재 지도에 찍힌 cafeList 원소들만 필터링
    for(var i = 0; i < cafeList.length; i++) {
        if(place[0].pk === cafeList[i].fields.cafe) {
            iconSize = cafeList[i].fields.visit_count;
            if(iconSize >= 10) {
                iconSize = 10;
            }
        }
    }
    // 마커 아이콘 크기 조정
    var imageSize = new kakao.maps.Size(16 + iconSize * 3, 16 + iconSize * 3);

    // 마커 생성
    var marker = new kakao.maps.Marker({
        map: map,
        title: place[0].fields.name,
        position: new kakao.maps.LatLng(place[0].fields.location_y, place[0].fields.location_x),
        image : new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption),
    });

    // 마커를 배열에 추가
    markers.push(marker);

    // 마커에 클릭이벤트 등록
    kakao.maps.event.addListener(marker, 'click', function() {
        // 마커를 클릭하면 장소명이 인포윈도우에 표출
        infowindow.setContent(`
            <div class="d-flex flex-column align-items-center" style="width: 150px; height: 80px;">
                <div class="fw-bold" style="padding:5px;font-size:12px;">${place[0].fields.name}</div>
                <div style="padding:5px;font-size:10px;">${place[0].fields.address}</div>
                <div style="padding:5px;font-size:10px;">
                    <a href="../cafe/review_list/${place[0].pk}">리뷰 보기</a>
                </div>
            </div>
        `);
        infowindow.open(map, marker);
    });
}

// markers에 있는 마커를 모두 제거하는 함수
function removeMarker() {
    for ( var i = 0; i < markers.length; i++ ) {
        markers[i].setMap(null);
    }   
    markers = [];
}

// 댓글 작성
const requestWrite = new XMLHttpRequest();

const commentWrite = (review_id) => {
    const url = '/cafe/comment_write/';
    const content = document.querySelector(`.input-${review_id}`).value;
    requestWrite.open('POST', url, true);
    requestWrite.setRequestHeader(
        'Content-Type',
        'application/x-www-form-urlencoded'
    );
    requestWrite.send(JSON.stringify({review_id: review_id, content:content}));
};

const writeResponse = () => {
    if(requestWrite.status < 400) {
        const {review_id, content, comment_id} = JSON.parse(requestWrite.response);
        const comments = document.querySelector(`.comments-${review_id}`);
        const element = document.querySelector(`.input-${review_id}`);
        comments.innerHTML += `
            <div class="comment-${comment_id} container-fluid my-1">
                <div class="row">
                    <div class="col">${content}</div>
                    <div class="col">
                        <button class="btn-primary" onclick="commentDelete('${comment_id}');">삭제</button>
                    </div>
                </div<
            </div>
        `;
    }
};

requestWrite.onreadystatechange = () => {
    if(requestWrite.readyState === XMLHttpRequest.DONE) {
        writeResponse();
    }
};

//댓글 삭제
const requestDelete = new XMLHttpRequest();

const commentDelete = (comment_id) => {
    const url = '/cafe/comment_delete/';
    requestDelete.open('POST', url, true);
    requestDelete.setRequestHeader(
        'Content-Type',
        'application/x-www-form-urlencoded'
    );
    requestDelete.send(JSON.stringify({comment_id: comment_id}));
};

const deleteResponse = () => {
    if(requestDelete.status < 400) {
        const {comment_id} = JSON.parse(requestDelete.response);
        const element = document.querySelector(`.comment-${comment_id}`);
        element.remove();
    }
};

requestDelete.onreadystatechange = () => {
    if(requestDelete.readyState === XMLHttpRequest.DONE) {
        deleteResponse();
    }
};
</script>
{% endblock %}